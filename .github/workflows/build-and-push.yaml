# GitHub Actions Workflow for natherin-frontend-web
#
# PURPOSE: Build Docker images and push to DigitalOcean Container Registry
# NO AUTOMATIC DEPLOYMENT - Manual helm upgrade required to deploy
#
# SETUP INSTRUCTIONS:
# 1. Backup current workflow:
#    mv .github/workflows/main.yaml .github/workflows/main.yaml.backup
# 2. This file replaces main.yaml for natherin-frontend-web
# 3. Ensure DIGITALOCEAN_PERSONAL_ACCESS_TOKEN secret exists (already configured)
# 4. Push and verify - no automatic deployment will occur

name: Build and Push Docker Image

on:
  push:
    branches:
      - main # Production-ready code
      - staging # Staging environment code (if you use this branch)
      - develop # Development/sand environment code (if you use this branch)
  pull_request:
    branches:
      - main

  # Allows manual trigger from Actions tab
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@main

      - name: Send Slack notification - Build started
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "ğŸ”¨ Build Started - natherin-frontend-web",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸ”¨ *Build Started* - natherin-frontend-web\n*Branch:* `${{ github.ref_name }}`\n*Commit:* <${{ github.event.head_commit.url }}|${{ github.sha }}>\n*Author:* ${{ github.actor }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_DEPLOY_WEBHOOK_URL }}
        continue-on-error: true

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_PERSONAL_ACCESS_TOKEN }}

      - name: Extract short SHA
        id: vars
        run: |
          SHORT_SHA=$(echo $GITHUB_SHA | head -c7)
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "Building image with tag: ${SHORT_SHA}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build container image
        run: |
          docker build \
            -t registry.digitalocean.com/zincan/natherin-frontend-web:${{ steps.vars.outputs.short_sha }} \
            -t registry.digitalocean.com/zincan/natherin-frontend-web:${GITHUB_REF##*/} \
            .

      - name: Send Slack notification - Image built
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "ğŸ³ Docker Image Built - natherin-frontend-web",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸ³ *Docker Image Built* - natherin-frontend-web\n*Branch:* `${{ github.ref_name }}`\n*Image Tag:* `${{ steps.vars.outputs.short_sha }}`\n*Author:* ${{ github.actor }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_DEPLOY_WEBHOOK_URL }}
        continue-on-error: true

      - name: Log in to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 1200

      - name: Push image to DigitalOcean Container Registry
        run: |
          docker push registry.digitalocean.com/zincan/natherin-frontend-web:${{ steps.vars.outputs.short_sha }}
          docker push registry.digitalocean.com/zincan/natherin-frontend-web:${GITHUB_REF##*/}

      - name: Send Slack notification - Image pushed
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "ğŸ“¦ Image Pushed to Registry - natherin-frontend-web",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸ“¦ *Image Pushed to Registry* - natherin-frontend-web\n*Branch:* `${{ github.ref_name }}`\n*Image Tag:* `${{ steps.vars.outputs.short_sha }}`\n*Full Image:* `registry.digitalocean.com/zincan/natherin-frontend-web:${{ steps.vars.outputs.short_sha }}`\n*Author:* ${{ github.actor }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_DEPLOY_WEBHOOK_URL }}
        continue-on-error: true

      # ========================================================================
      # DEPLOYMENT STEPS REMOVED
      # The following steps from the old workflow are NO LONGER RUN:
      # - Update deployment file (sed command)
      # - Save kubeconfig
      # - Deploy the frontend via kubectl apply
      # - Verify deployment via kubectl rollout status
      #
      # Deployment is now manual via Helm chart upgrade
      # ========================================================================

      - name: Output deployment instructions
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Docker image built and pushed successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“¦ Image: registry.digitalocean.com/zincan/natherin-frontend-web:${{ steps.vars.outputs.short_sha }}"
          echo "ğŸ·ï¸  Tags: ${{ steps.vars.outputs.short_sha }}, ${GITHUB_REF##*/}"
          echo ""
          echo "ğŸš€ TO DEPLOY THIS IMAGE:"
          echo ""
          echo "Run helm chart upgrade with the new image tag:"
          echo ""
          echo "  helm upgrade natherin-frontend-web ./helm/natherin-frontend-web \\"
          echo "    --set image.tag=${{ steps.vars.outputs.short_sha }} \\"
          echo "    --namespace natherin-frontend-production"
          echo ""
          echo "ğŸ“ View available images:"
          echo "  doctl registry repository list-tags zincan/natherin-frontend-web"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ³ Docker Image Built

              **Image Tag:** \`${{ steps.vars.outputs.short_sha }}\`

              **Full Image:** \`registry.digitalocean.com/zincan/natherin-frontend-web:${{ steps.vars.outputs.short_sha }}\`

              ### To Deploy:
              Run helm chart upgrade with the new image tag:
              \`\`\`bash
              helm upgrade natherin-frontend-web ./helm/natherin-frontend-web \\
                --set image.tag=${{ steps.vars.outputs.short_sha }} \\
                --namespace natherin-frontend-production
              \`\`\`

              âš ï¸ **Note:** This PR build will NOT be automatically deployed. You must manually deploy after merging.
              `
            })

      - name: Send Slack notification - Build completed
        if: success()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "âœ… Build Completed - natherin-frontend-web",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "âœ… *Build Completed Successfully* - natherin-frontend-web\n*Branch:* `${{ github.ref_name }}`\n*Image Tag:* `${{ steps.vars.outputs.short_sha }}`\n*Full Image:* `registry.digitalocean.com/zincan/natherin-frontend-web:${{ steps.vars.outputs.short_sha }}`\n*Author:* ${{ github.actor }}\n\n*To Deploy:*\n```helm upgrade natherin-frontend-web ./helm/natherin-frontend-web --set image.tag=${{ steps.vars.outputs.short_sha }} --namespace natherin-frontend-production```"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_DEPLOY_WEBHOOK_URL }}
        continue-on-error: true

      - name: Send Slack notification - Build failed
        if: failure()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "âŒ Build Failed - natherin-frontend-web",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "âŒ *Build Failed* - natherin-frontend-web\n*Branch:* `${{ github.ref_name }}`\n*Commit:* <${{ github.event.head_commit.url }}|${{ github.sha }}>\n*Author:* ${{ github.actor }}\n*Workflow:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_DEPLOY_WEBHOOK_URL }}
        continue-on-error: true
